#+TITLE: Clients - klutshnik Key Management System
#+AUTHOR: klutshnik
#+OPTIONS:   H:2 num:t toc:nil \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc

#+BEGIN_EXPORT html
<img src="keeper7keys.jpg" style="float:right;position:absolute;right:10px;top:10px;" width="100em" />
<ul >
    <li style="display: inline;"><a href="/">Home</a></li>
    <li style="display: inline;">Install Client</li>
    <li style="display: inline;"><a href="servers.html">Find Servers</a></li>
    <li style="display: inline;"><a href="server_install.html">Host Server</a></li>
    <li style="display: inline;"><a href="device_install.html">Host Device</a></li>
    <li style="display: inline;"><a href="docs.html">Docs</a></li>
    <li style="display: inline;"><a href="code.html">Code</a></li>
    <li style="display: inline;"><a href="faq.html">FAQ</a></li>
</ul>
<hr />
#+END_EXPORT

The klutshnik client is your gateway to secure data storage and key management.

All cryptographic operations happen locally on your device, ensuring your data never leaves your device in plaintext. The client talks to these servers using a **Verifiable Oblivious Pseudo-Random Function (VOPRF)** protocol (based on [[https://datatracker.ietf.org/doc/rfc9497/][RFC 9497]]), allowing them to help you unlock your data without ever learning your secrets.

* Installing the Client

** Package Manager Installation (Recommended)

This is the fastest way to get started.

*** Debian-Based Systems (Debian, Ubuntu, Kali, Raspbian)

/Currently available in testing and unstable./

#+BEGIN_SRC sh
apt install klutshnik
#+END_SRC

This installs the complete Klutshnik client with all dependencies
resolved automatically. After installation, proceed to the
configuration section below.

** Building from Source

For systems without package manager support or users wanting the latest
development version, you can build from source.


** 1. Install Dependencies
You need to adjust the package names according to your distribution's naming conventions.
To install on Debian-based systems:
#+BEGIN_SRC sh
apt install python libsodium libsodium-dev gcc g++
#+END_SRC

** 2. Install liboprf

liboprf is a library for Oblivious Pseudorandom Functions (OPRFs), including
support for threshold OPRFs. An OPRF is a cryptographic protocol that allows
client to get a pseudorandom function of a secret key held by a server, without
the server learning the secret key. To install, run:

#+BEGIN_SRC sh
git clone https://github.com/stef/liboprf.git
cd liboprf/src
make
sudo PREFIX=/usr make install
cd ../..
#+END_SRC

** 3. Install libklutshnik

libklutshnik is the core C library for Klutshnik. To install, run:

#+BEGIN_SRC sh
git clone https://github.com/stef/klutshnik.git
cd klutshnik
make
sudo PREFIX=/usr make install
cd ..
#+END_SRC

** 4. Install the Klutshnik client
With the dependencies in place, install the Python Klutshnik client:
#+BEGIN_SRC sh
python3 -m virtualenv --copies --system-site-packages env
source env/bin/activate
pip install klutshnik
#+END_SRC

*** Verification

Verify the installation was successful:
#+BEGIN_SRC sh
klutshnik --version
#+END_SRC

* Configuring the Client

The configuration system uses a hierarchical approach that allows
system-wide defaults with user-specific overrides.

** Configuration File Locations

Klutshnik reads configuration files in this specific order, with later
files overriding earlier settings:

1. ~/etc/klutshnik/config~ - System-wide configuration
2. ~~/.klutshnikrc~ - User-specific configuration
3. ~~/.config/klutshnik/config~ - XDG-compliant user configuration
4. ~./klutshnik.cfg~ - Project or directory-specific configuration

This hierarchy allows global defaults while letting users customize
their personal settings.

** Basic Configuration Template

Copy this into one of the locations above (e.g., ~./klutshnik.cfg~). This template assumes
a minimal setup with 3 Klutshnik devices - one TCP, one using
Bluetooth LE and one connected via USB serial port.


#+BEGIN_EXAMPLE
[client]
verbose = false
keystore="~/.local/klutshnik/keystore"
threshold = 3
#ltsigkey_path="~/.config/klutshnik/client.key"
ltsigpub="LTSIGPK-<base64 encoded key>"
id_salt="<GENERATE_A_RANDOM_STRING_HERE>"

[servers]
[servers.klutshnik1]
address=klutshnik1.example.com
port=443
ltsigkey_path="klutshnik1.pub"

[servers.usb-serial0]
usb_serial = "58378277238889F8"
ltsigkey = "<base64 encoded key>"
device_pk = "<base64 encoded key>"
client_sk = "<base64 encoded key>"

[servers.ble_C82FCB83C09D]
bleaddr = "C8:2F:CB:83:C0:9D"
ltsigkey = "<base64 encoded key>"
device_pk = "<base64 encoded key>"
client_sk = "<base64 encoded key>"
#+END_EXAMPLE

** Client Configuration Parameters

In the ~[client]~ section, you can configure the following parameters:

- *~verbose~*: Controls the logging detail.  You probably want to keep
  on ~false~ if everything works, and only temporarily enable it to
  debug issues
- *~keystore~*: Specifies where Klutshnik caches some non-sensitive
  key-related metadata. The default location should be good enough in
  most deployments.
- *~threshold~*: The number of servers required to reconstruct your key. Setting ~threshold~ to 1
  uses traditional single-server operation. Values greater than 1
  require you to configure multiple servers in the ~[servers]~ section, described below.
  Higher threshold = higher security (attacker needs to compromise more servers) but lower availability (more servers must be online for you to work). You must configure at least ~threshold+1~ servers.
- *~id_salt~*: This random string is used generate all key IDs for your records. It has no default and you must set this value. If you lose this value, you will lose access to all your keys.

** Server Configuration Parameters

In the ~[servers]~ section, you define your servers.

- Named servers subsection: These names follow the format
  ~[servers.name]~. Choose unique, descriptive names for your server
  sections like ~[servers.primary]~ or ~[servers.backup1]~. You can use
  any names you like, but do not change them after they are set.
- *~ltsigkey~* or *~ltsigkey_path~*: ~ltsigkey~ contains the server's
  long-term signing public key, encoded in base64
  format. Alternatively, use ~ltsigkey_path~, which specifies a path
  to a raw binary file containing the public key. This key is only
  required for threshold setups.

For TCP based servers over the network:
- *~address~*: Points at the host. This is either an IPv4 or IPv6 IP
  address, or a hostname.
- *~port~*: Sets the TCP port the server is listening on. Default is 443.

For dedicated Klutshnik devices on microcontrollers (these values are
automatically added if the device is initialized using the ~klutshnik
provision~ operation):
- *~usb_serial~*: The serial number of the USB Serial device. This
  attribute conflicts with ~bleaddr~, a device can only be either USB or Bluetooth LE (BLE).
- *~bleaddr~*: The Bluetooth LE MAC address of the device. This
  attribute conflicts with ~usb_serial~, a device can only be either
  USB or BLE.
- *~device_pk~*: The public [Noise protocol](http://noiseprotocol.org) key of the device.
- *~client_sk~*: The dedicated private Noise key of the client  associated with the device.

If you are not hosting your own servers, choose servers operated by
different third parties to maximize security through trust distribution.

* Initializing the Client

Once configured, initialize your client to generate your master identity keys:

#+BEGIN_SRC sh
klutshnik init <path-to-klutshnik.cfg>
#+END_SRC

This creates the ~keystore~ directory, a client master key and outputs your long-term signing and short-term public keys. 
You must add the long-term signing public key to the ~authorized_keys~ file of every server you want to use. This key is
also needed if you want to be authorized to use Klutshnik keys owned by other
users.

