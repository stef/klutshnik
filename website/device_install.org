#+TITLE: Hardware Devices - klutshnik Key Management System
#+AUTHOR: klutshnik
#+OPTIONS:   H:4 num:t toc:nil \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc

#+BEGIN_EXPORT html
<img src="keeper7keys.jpg" style="float:right;position:absolute;right:10px;top:10px;" width="100em" />
<ul >
    <li style="display: inline;"><a href="/">Home</a></li>
    <li style="display: inline;"><a href="client_install.html">Install Client</a></li>
    <li style="display: inline;"><a href="servers.html">Find Servers</a></li>
    <li style="display: inline;"><a href="server_install.html">Host Server</a></li>
    <li style="display: inline;">Host Device</li>
    <li style="display: inline;"><a href="docs.html">Docs</a></li>
    <li style="display: inline;"><a href="code.html">Code</a></li>
    <li style="display: inline;"><a href="faq.html">FAQ</a></li>
</ul>
<hr />
#+END_EXPORT

* Klutshnik Devices

Klutshnik devices are tiny dedicated devices that run on a
microcontroller like an ESP32 or a Cortex-M series ARM. These connect
either using USB or Bluetooth LE to your computer.

Instead of trusting a server on the internet, you can trust a device in your pocket. It runs the same blinded protocol as a server, meaning even if your computer is compromised, the attacker cannot extract the key share from this hardware device.

* Supported Devices

Klutshnik currently supports the following devices:
- **Espressif:** Seeedstudio [[https://wiki.seeedstudio.com/xiao_esp32s3_getting_started/][XIAO ESP32 S3]] (USB and BLE)
- **Raspberry Pi (RPi):** [[https://www.raspberrypi.com/products/raspberry-pi-pico-2/][Pico 2 W]] (USB)
- **Teensy:** [[https://www.pjrc.com/store/teensy41.html][4.1]] and [[https://www.pjrc.com/store/teensy40.html][4.0]] (USB)

Currently, only the XIAO ESP32 S3 supports wireless connections using Bluetooth LE (BLE). The other boards can only communicate using USB connections.

Since Klutshnik uses [[https://zephyrproject.org/][Zephyr OS]] as the real-time operating system, it
is possible to port Klutshnik to other boards, especially if
they are based on the ESP32 S3 or RP2350 microcontrollers.
As soon as Zephyr OS supports BLE for the RPi Pico 2 W, this device will
be able to support either USB or BLE.


* Building the Firmware

Currently, you have to build it yourself.

** 1. Dependencies

You need several Python tools and the Zephyr SDK:
#+BEGIN_SRC sh
pip install west pyserial tomlkit pyudev pysodium pyoprf
#+END_SRC

If you target an **ESP32** device you also need the ~xtensa-esp32s3-elf~
cross-compiler toolchain and the ~esptool~
tool to flash the device:

#+BEGIN_SRC sh
pip install esptool
#+END_SRC

If you target a **Teensy** device, you also need the [[https://www.pjrc.com/teensy/loader_cli.html][Teensy Loader CLI]] and
the ~arm-none-eabi~ cross-compiler toolchain.   
~arm-none-eabi~ cross-compiler toolchain.

For the **Raspberry Pico 2** device, you also need the ~arm-none-eabi~
cross-compiler toolchain.
** 2. Initializing your Zephyr Workspace

[[https://github.com/stef/klutshnik-zephyr][~klutshnik-zephyr~]] is a port of the Klutshnik server to Zephyr OS

#+BEGIN_SRC sh
west init -m https://github.com/stef/klutshnik-zephyr workspace
cd workspace
west update
west blobs fetch hal_espressif hal_infineon
cd klutshnik-zephyr
#+END_SRC

** 3. Building the Image

*XIAO ESP32 S3  (BLE + USB):*
#+BEGIN_SRC sh
FILE_SUFFIX=ble \
   ZEPHYR_TOOLCHAIN_VARIANT=cross-compile \
   CROSS_COMPILE=/usr/bin/xtensa-esp32s3-elf- \
   west build -p auto -b xiao_esp32s3/esp32s3/procpu klutshnik -DCONFIG_KLUTSHNIK_BLE=y
#+END_SRC

*For Teensy 4.x (USB):*
#+BEGIN_SRC sh
FILE_SUFFIX=uart \
   ZEPHYR_TOOLCHAIN_VARIANT=cross-compile \
   CROSS_COMPILE=/usr/bin/arm-none-eabi- \
   west build -p auto -b teensy41 klutshnik -DCONFIG_KLUTSHNIK_USB_CDC=y
#+END_SRC
Replace ~teensy41~ with ~teensy40~ where appropriate.

*For Raspberry Pico 2 (USB):*
#+BEGIN_SRC sh
FILE_SUFFIX=uart \
   ZEPHYR_TOOLCHAIN_VARIANT=cross-compile \
   CROSS_COMPILE=/usr/bin/arm-none-eabi- \
   west build -p auto -b rpi_pico2/rp2350a/m33 klutshnik -DCONFIG_KLUTSHNIK_USB_CDC=y
#+END_SRC


** 4. Flashing the Images

*XIAO ESP32 S3 :*
First, connect your device via USB. Then, flash the image:
#+BEGIN_SRC sh
# Find your port (usually /dev/ttyACM0)
west flash --esp-device=/dev/ttyACM0
#+END_SRC
Just omit the ~--esp-device~ param and it will auto-probe for the right port, though it will be a bit slower.

*For Teensy 4.x:*
If you have the Teensy CLI loader:

#+BEGIN_SRC sh
west flash
#+END_SRC

*For Raspberry Pico 2:*
#+BEGIN_SRC sh
west flash
#+END_SRC

* Provisioning a new device

Before using your Klutshnik device, you must provision it. 
First, connect your device via USB (even for the BLE XIAO ESP32 S3).

** Step 1: Initialize Identity

This command generates an identity for the device and authorizes your client to communicate with it initially.

#+BEGIN_SRC sh
klutshnik provision /dev/ttyACM0 test/klutshnik.cfg test/servers/authorized_keys uart
#+END_SRC

However, if you use an ESP32 S3-based device, you must use the ~esp~ mode:

#+BEGIN_SRC sh
klutshnik provision /dev/ttyACM0 test/klutshnik.cfg test/servers/authorized_keys esp
#+END_SRC

The ~/dev/ttyACM0~ value is a default port, and you should replace it with the actual port your device is connected to. 
~test/klutshnik.cfg~ is a test config file, you can replace it with your own config file. 
Make sure that the
~authorized_keys~ file contains all other devices already you want to
use.

** Step 2: Update Authorized Keys

At the end of the provisioning, the script outputs a value. you must add this string to the ~authorized_keys~ file of every other Klutshnik server in your threshold group.

This authorization ensures your hardware device can participate in collective
key rotations with other servers. For the local test environment, append
this string to the ~test/servers/authorized_keys~ file.

* Manual Device Configuration

The ~klutshnik provision~ operations should get you all set up. But if
you later have to do some reconfiguration,  ~klutshnik-zephyr~ comes with a USB UART shell that allows you to do this manually. 

For
Klutshnik devices that use USB for communication, there are two serial ports:
1.  The management port with the shell and the log.
2.  The protocol port, the actual key management interface.
If you have both ~/dev/ttyACM0~ and ~/dev/ttyACM1~, then the
shell is on ~/dev/ttyACM0~.


** Supported Commands

The following commands are supported:

To set the owner's client long-term signing public key:
#+BEGIN_SRC sh
init ltsig <base64 ltsig pubkey>
#+END_SRC

To set the owner's client Noise public key:
#+BEGIN_SRC sh
init noise <base64 noise pubkey>
#+END_SRC

For initial provisioning to be completed, you must run the above two ~init~ commands, and have at least 3 entries in the ~authorized_keys~ file. To check completion, run:

#+BEGIN_SRC sh
init check
#+END_SRC


To add a new entry to the ~authorized_keys~ file:
#+BEGIN_SRC sh
authkey add <base64 authkey entry>
#+END_SRC

To delete the ~authorized_keys~ file:

#+BEGIN_SRC sh
authkey del
#+END_SRC

To get the contents of the ~authorized_keys~ file:

#+BEGIN_SRC sh
authkey get
#+END_SRC

To get the device's long-term signing key:

#+BEGIN_SRC sh
getcfg ltsig
#+END_SRC

To get the device's Noise protocol public key:

#+BEGIN_SRC sh
getcfg noise
#+END_SRC

To get the device's Bluetooth MAC address (for BLE devices only):


#+BEGIN_SRC sh
getcfg mac
#+END_SRC

* Testing

The repository ships with a configured 5-way test setup in the ~test/~ directory. It runs 5 servers on hardware device. 

** 1. Start Test Servers
Run the provided test servers (TLS-based) in a separate terminal:
#+BEGIN_SRC sh
cd test/servers
rm -rf */data
# Point ORACLE to your compiled klutshnikd binary
ORACLE=../../server/bin/klutshnikd ./start-servers.sh
#+END_SRC

** 2. (Optional) Monitor the device logs
As soon as you have the servers running. Power up your BLE device
using USB. In a second terminal, you can monitor the device logs by
running (assuming the device is available on ~/dev/ttyACM0~):
#+BEGIN_SRC sh
west espressif monitor -p /dev/ttyACM0
#+END_SRC

or you could just use plain old socat
#+BEGIN_SRC sh
socat /dev/ttyACM0,b115200,raw,echo=0 -,escape=0x0f
#+END_SRC


** 3. Run tests
In a third terminal, run the test suite. This simulates a client performing a full key rotation cycle involving your hardware device. For this, you need to [[file:client_install.org][have the
Klutshnik client installed]] on your path.
#+BEGIN_SRC sh
cd test
# Clean old keystore
rm -rf otherclient/keystore/[0-9a-f]*
./test.sh
#+END_SRC
