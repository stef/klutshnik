
#+TITLE: FAQ - klutshnik Key Management System
#+AUTHOR: klutshnik
#+OPTIONS:   H:2 num:t toc:nil \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc
#+options:   tex:dvisvgm

#+BEGIN_EXPORT html
<style>
    .org-svg {vertical-align: middle};
</style>
<img src="keeper7keys.jpg" style="float:right;position:absolute;right:10px;top:10px;" width="100em" />
<ul >
    <li style="display: inline;"><a href="/">Home</a></li>
    <li style="display: inline;"><a href="client_install.html">Install Client</a></li>
    <li style="display: inline;"><a href="servers.html">Find Servers</a></li>
    <li style="display: inline;"><a href="server_install.html">Host Server</a></li>
    <li style="display: inline;"><a href="device_install.html">Host Device</a></li>
    <li style="display: inline;"><a href="docs.html">Docs</a></li>
    <li style="display: inline;"><a href="code.html">Code</a></li>
    <li style="display: inline;">FAQ</li>
</ul>
<hr />
#+END_EXPORT

* How does the key rotation work?

A core innovation of Klutshnik is rotating the Key Encryption Key (KEK) without decrypting the data.

This is possible because the Data Encryption Key (DEK) is not a static file, but the output of an Oblivious Pseudo-Random Function (OPRF). An OPRF is a two-party protocol where a client (holding an input ~w~) and a server (holding a secret key ~KEK~) interact such that the client computes the output ~DEK~, but the server learns nothing about the client's input ~w~ and the client learns nothing about the server's secret ~KEK~. In a threshold OPRF, the key ~KEK~ is split among a number (threshold) of servers, such that the compromise of any individual server does not compromise the key.

In a non-threshold setting:
- ~KEK~: Held by the server.
- ~w~: A per-file value held by the client/storage.
- ~DEK~: The derived key used to encrypt the file.

#+BEGIN_CENTER
   $DEK = OPRF(KEK, w) = w \cdot KEK$
#+END_CENTER

We use a specific OPRF variant, HashDH, that preserves algebraic structure. This allows us to perform operations on the ~KEK~ components while keeping the resulting ~DEK~ stable.

** The Rotation Process

When we rotate keys, the server chooses a random scalar value $\delta_{i}$ (the update token) and updates its share of the key:

#+BEGIN_CENTER
   $KEK_{i+1} = KEK_{i} \cdot \delta_{i}$
#+END_CENTER

The server then shares $\delta_{i}$ with the untrusted storage server. The storage server updates the blinded input ~w~ for every file:

#+BEGIN_CENTER
   $w_{i+1} = \frac{w_{i}}{\delta_{i}}$
#+END_CENTER

Because of the algebraic properties, the resulting DEK remains identical, even though both the KEK and the input ~w~ have changed:

#+BEGIN_CENTER
   $DEK = w_1 \cdot KEK_1 = w_0 \cdot KEK_0$

   $\frac{w_0}{\delta_{0}} \cdot KEK_0 \cdot \delta_{0}$
#+END_CENTER

** Threshold Rotation

In the threshold setting, the ~KEK~ is never held by a single server. It is split among shareholders using verifiable [[https://en.wikipedia.org/wiki/Shamir%27s_secret_sharing][Shamir's Secret Sharing]].

The new $KEK_{i+1}$ is calculated via a multi-party computation between the servers. They multiply their shares by the update factor without ever reconstructing the full key.

** Security Implications

Crucially, the storage server performing the update sees only the update token $\delta_{i}$ and the blinded inputs ~w~. It never learns:
- The ~KEK~
- The ~DEK~
- The plaintext data

We trust the storage only for **Availability** (keeping data) and **Integrity** (performing the multiplication correctly).

* Why use HashDH instead of 2HashDH?

Klutshnik uses a HashDH-style OPRF, distinct from the more common 2HashDH variant. This is important since this OPRF variant retains algebraic properties, which would be destroyed by the 2nd hash
in the 2HashDH OPRF.

* What's with this weird name Klutshnik?

It is a homage to the all the great cryptographers having a
Polish/Slavic background. 'kljutsh' (or variations of it) means "key"
in Slavic languages, and the 'nik' postfix means something like
"person" just like in Beatnik. Together, they mean "person of keys" or
"key person". Anyway, I think it is a much better name than GNU
Keymaster 3000 Deluxe Pro.
